package com.sh.engine.plugin.lol;

import com.alibaba.fastjson.JSON;
import com.google.common.collect.Lists;
import lombok.Data;
import org.apache.commons.collections4.CollectionUtils;

import java.util.Comparator;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

/**
 * @Author caiwen
 * @Date 2024 01 13 23 26
 **/
@Data
public class LoLPicData {
    private int K;
    private int D;
    private int A;
    private Integer targetIndex;

    private HeroKillOrAssistDetail heroKADetail;

    public LoLPicData() {
    }

    public LoLPicData(int k, int d, int a) {
        K = k;
        D = d;
        A = a;
    }

    public LoLPicData copy() {
        return new LoLPicData(this.K, this.D, this.A);
    }

    public List<List<Integer>> merge2PositionEnum() {
        if (heroKADetail == null) {
            return Lists.newArrayList();
        }

        List<HeroProfile> profiles = Lists.newArrayList();
        for (int i = 0; i < heroKADetail.getBoxes().size(); i++) {
            HeroProfile heroProfile = new HeroProfile();
            heroProfile.setPosition(heroKADetail.getBoxes().get(i));
            heroProfile.setLabelId(heroKADetail.getLabelIds().get(i));
            profiles.add(heroProfile);
        }

        List<HeroProfile> sortedProfiles = profiles.stream()
                .sorted(Comparator.comparing(p -> p.getPosition().get(3)))
                .collect(Collectors.toList());
        List<List<Integer>> labelIdPerKills = Lists.newArrayList();
        Float lastMaxYPosition = null;
        for (int i = 0; i < sortedProfiles.size(); i++) {
            HeroProfile heroProfile = sortedProfiles.get(i);
            if (lastMaxYPosition != null && Math.abs(lastMaxYPosition - heroProfile.getPosition().get(3)) < 5f) {
                // 小于5属于同一行，说明是同一次击杀
                labelIdPerKills.get(labelIdPerKills.size() - 1).add(heroProfile.getLabelId());
            } else {
                labelIdPerKills.add(Lists.newArrayList(heroProfile.getLabelId()));
            }

            lastMaxYPosition = heroProfile.getPosition().get(3);
        }

        return labelIdPerKills.stream().map(LOLHeroPositionEnum::filter).filter(CollectionUtils::isNotEmpty)
                .collect(Collectors.toList());

    }

    public static LoLPicData genBlank() {
        return new LoLPicData(-1, -1, -1);
    }

    public static LoLPicData genInvalid() {
        return new LoLPicData(-2, -2, -2);
    }

    public boolean beInvalid() {
        return this.K == -2;
    }

    public boolean beBlank() {
        return this.K == -1;
    }

    public boolean beValid() {
        return this.K >= 0;
    }

    public boolean compareKda(LoLPicData other) {
        if (other == null) {
            return false;
        }
        return Objects.equals(this.K, other.K) && Objects.equals(this.D, other.D) && Objects.equals(this.A, other.A);
    }

    public static class HeroKillOrAssistDetail {
        private List<List<Float>> boxes;

        /**
         * @see LOLHeroPositionEnum
         */
        private List<Integer> labelIds;

        public List<List<Float>> getBoxes() {
            return boxes;
        }

        public HeroKillOrAssistDetail() {
        }

        public HeroKillOrAssistDetail(List<List<Float>> boxes, List<Integer> labelIds) {
            this.boxes = boxes;
            this.labelIds = labelIds;
        }

        public void setBoxes(List<List<Float>> boxes) {
            this.boxes = boxes;
        }

        public List<Integer> getLabelIds() {
            return labelIds;
        }

        public void setLabelIds(List<Integer> labelIds) {
            this.labelIds = labelIds;
        }
    }

    static class HeroProfile {
        private List<Float> position;
        private int labelId;

        public List<Float> getPosition() {
            return position;
        }

        public void setPosition(List<Float> position) {
            this.position = position;
        }

        public int getLabelId() {
            return labelId;
        }

        public void setLabelId(int labelId) {
            this.labelId = labelId;
        }
    }

    public static void main(String[] args) {
//        String s = "{\"boxes\": [[42.75518798828125, 61.551414489746094, 67.35529327392578, 88.9068374633789], [76.00764465332031, 60.21605682373047, 102.673828125, 87.25786590576172], [109.8975601196289, 60.964508056640625, 135.60031127929688, 86.39189147949219], [144.0944366455078, 45.97359085083008, 184.45704650878906, 87.26968383789062], [223.13299560546875, 46.473426818847656, 262.9591979980469, 86.8823013305664], [18.425003051757812, 62.11389923095703, 51.383262634277344, 88.14152526855469], [112.60234832763672, 253.4003448486328, 142.09275817871094, 289.7720031738281], [5.358659267425537, 59.29855728149414, 38.53472900390625, 89.4976806640625], [112.33692932128906, 264.87127685546875, 141.14788818359375, 293.9037170410156], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [143.0162353515625, 45.8076286315918, 183.9541473388672, 87.31964111328125], [222.36138916015625, 46.072635650634766, 263.46295166015625, 87.46341705322266], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [41.72496795654297, 61.06037139892578, 67.37284088134766, 88.06716918945312], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [222.36138916015625, 46.072635650634766, 263.46295166015625, 87.46341705322266], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [143.00900268554688, 46.408565521240234, 183.42062377929688, 87.25874328613281], [41.72496795654297, 61.06037139892578, 67.37284088134766, 88.06716918945312], [111.99427795410156, 244.28396606445312, 143.19004821777344, 288.2205505371094], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [110.4462661743164, 61.060752868652344, 135.42799377441406, 86.58486938476562], [75.7724609375, 60.03482437133789, 102.3033447265625, 87.81165313720703], [42.75518798828125, 61.551414489746094, 67.35529327392578, 88.9068374633789], [144.0944366455078, 45.97359085083008, 184.45704650878906, 87.26968383789062], [110.99246978759766, 51.85698318481445, 132.6329345703125, 81.53196716308594], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [97.58468627929688, 161.5516815185547, 279.3287048339844, 284.3720703125], [112.60234832763672, 253.4003448486328, 142.09275817871094, 289.7720031738281], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [18.425003051757812, 62.11389923095703, 51.383262634277344, 88.14152526855469], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [143.56591796875, 45.60493850708008, 183.7560577392578, 87.45484161376953], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [41.77311706542969, 61.26432418823242, 68.00349426269531, 88.58151245117188], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [222.64187622070312, 45.98601150512695, 263.0244445800781, 87.30482482910156], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [110.55081939697266, 61.063514709472656, 135.06634521484375, 87.04142761230469], [75.7724609375, 60.03482437133789, 102.3033447265625, 87.81165313720703], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [41.72496795654297, 61.06037139892578, 67.37284088134766, 88.06716918945312], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [144.04452514648438, 45.8543815612793, 184.2742462158203, 87.51677703857422], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [10.85535717010498, 66.53219604492188, 183.9624786376953, 179.32101440429688], [41.77311706542969, 61.26432418823242, 68.00349426269531, 88.58151245117188], [76.00764465332031, 60.21605682373047, 102.673828125, 87.25786590576172], [142.41693115234375, 46.29615783691406, 183.048583984375, 87.16551208496094], [110.08739471435547, 60.97039031982422, 135.99298095703125, 86.48345184326172], [97.58468627929688, 161.5516815185547, 279.3287048339844, 284.3720703125], [42.28989028930664, 160.76991271972656, 227.93133544921875, 291.07720947265625], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [222.84434509277344, 46.32244873046875, 262.3069152832031, 88.02205657958984], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [143.80865478515625, 45.7779655456543, 183.78492736816406, 87.29346466064453], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [41.77311706542969, 61.26432418823242, 68.00349426269531, 88.58151245117188], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [10.85535717010498, 66.53219604492188, 183.9624786376953, 179.32101440429688], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [222.84434509277344, 46.32244873046875, 262.3069152832031, 88.02205657958984], [143.00900268554688, 46.408565521240234, 183.42062377929688, 87.25874328613281], [73.9979248046875, 160.0420379638672, 277.0826721191406, 288.6039733886719], [41.552616119384766, 60.994712829589844, 67.7253189086914, 89.09310150146484], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [76.65055084228516, 60.57282638549805, 102.97511291503906, 87.26200103759766], [91.54749298095703, 81.56951904296875, 269.7672119140625, 188.90675354003906], [79.50594329833984, 104.89476013183594, 276.12451171875, 249.36325073242188], [110.47098541259766, 61.02616500854492, 135.63034057617188, 86.99066925048828], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [42.75518798828125, 61.551414489746094, 67.35529327392578, 88.9068374633789], [75.7724609375, 60.03482437133789, 102.3033447265625, 87.81165313720703], [110.47098541259766, 61.02616500854492, 135.63034057617188, 86.99066925048828], [143.56591796875, 45.60493850708008, 183.7560577392578, 87.45484161376953], [223.13299560546875, 46.473426818847656, 262.9591979980469, 86.8823013305664], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [97.58468627929688, 161.5516815185547, 279.3287048339844, 284.3720703125], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [-161.37606811523438, -113.97504425048828, 214.49490356445312, 289.51495361328125], [222.86532592773438, 46.22011947631836, 262.8226013183594, 86.67571258544922], [41.552616119384766, 60.994712829589844, 67.7253189086914, 89.09310150146484], [44.592323303222656, 168.3796844482422, 226.06317138671875, 295.496337890625], [110.47098541259766, 61.02616500854492, 135.63034057617188, 86.99066925048828], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375], [76.65055084228516, 60.57282638549805, 102.97511291503906, 87.26200103759766], [41.552616119384766, 60.994712829589844, 67.7253189086914, 89.09310150146484], [-54.54768371582031, -115.62831115722656, 323.9280700683594, 291.35833740234375]], \"label_ids\": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 11, 11], \"scores\": [0.6227366924285889, 0.5432235598564148, 0.5259679555892944, 0.25664350390434265, 0.06245295703411102, 0.059403929859399796, 0.057700224220752716, 0.05414833128452301, 0.04981747269630432, 0.04980994760990143, 0.04889768734574318, 0.9647641777992249, 0.28398025035858154, 0.18844662606716156, 0.1435079723596573, 0.11300603300333023, 0.08041931688785553, 0.06156375631690025, 0.04921264201402664, 0.8876766562461853, 0.12856261432170868, 0.09422873705625534, 0.09358468651771545, 0.08382256329059601, 0.079979807138443, 0.07417479157447815, 0.056633301079273224, 0.049412865191698074, 0.6555994749069214, 0.6329758167266846, 0.4618527889251709, 0.12607182562351227, 0.059087593108415604, 0.05614624172449112, 0.05346347764134407, 0.05102575570344925, 0.05088277906179428, 0.05050991475582123, 0.049675386399030685, 0.25177744030952454, 0.1730032116174698, 0.11088941991329193, 0.11046547442674637, 0.07796870917081833, 0.0644470825791359, 0.04936115816235542, 0.21207301318645477, 0.13441726565361023, 0.11524217575788498, 0.0952768549323082, 0.08889912068843842, 0.08402340114116669, 0.0824463814496994, 0.06429645419120789, 0.05579753965139389, 0.0494951456785202, 0.04895063862204552, 0.26294955611228943, 0.15080709755420685, 0.12273893505334854, 0.10688474029302597, 0.058903768658638, 0.05667928606271744, 0.049420442432165146, 0.2465159296989441, 0.19428403675556183, 0.15256494283676147, 0.11836723238229752, 0.09321488440036774, 0.08466250449419022, 0.06415683776140213, 0.049941807985305786, 0.04897747188806534, 0.41317492723464966, 0.24374184012413025, 0.11650262027978897, 0.10744057595729828, 0.08884330838918686, 0.0680973082780838, 0.06123492866754532, 0.060168974101543427, 0.056989435106515884, 0.05021584406495094, 0.3159851133823395, 0.2902517318725586, 0.2881433069705963, 0.12191158533096313, 0.053717851638793945, 0.05073273926973343, 0.04976927861571312, 0.04957291856408119, 0.04896467924118042, 0.10822806507349014, 0.0675864890217781, 0.05603421479463577, 0.05007261410355568, 0.0498369038105011, 0.04908691346645355, 0.05770454555749893, 0.04918190464377403]}";
        String s = "{\"boxes\": [[109.70105743408203, 123.02367401123047, 134.42674255371094, 148.6913299560547], [75.97394561767578, 122.02716827392578, 101.250732421875, 148.20469665527344], [142.97390747070312, 108.17310333251953, 184.66873168945312, 149.76260375976562], [221.98519897460938, 107.00719451904297, 263.8313293457031, 150.00428771972656], [110.09139251708984, 60.69276809692383, 136.041259765625, 87.47020721435547], [43.031410217285156, 60.65851974487305, 67.99030303955078, 86.98234558105469], [76.10076141357422, 184.0489959716797, 101.41070556640625, 212.05419921875], [109.48263549804688, 249.38653564453125, 134.05931091308594, 274.149169921875], [109.7554931640625, 122.52027893066406, 134.75743103027344, 148.60816955566406], [221.69224548339844, 170.8177490234375, 263.1825256347656, 212.6924591064453], [222.12115478515625, 234.34963989257812, 263.3885803222656, 276.3937683105469], [221.45730590820312, 46.493080139160156, 263.4265441894531, 87.23698425292969], [107.47384643554688, 184.46932983398438, 137.95407104492188, 213.75563049316406], [73.85922241210938, 59.919647216796875, 104.4168701171875, 89.45374298095703], [73.71341705322266, 246.95223999023438, 104.18475341796875, 275.95904541015625], [142.1325225830078, 45.28845977783203, 184.6024932861328, 87.79536437988281], [142.65228271484375, 170.18753051757812, 184.2667999267578, 213.27886962890625], [141.5957794189453, 232.50006103515625, 184.8866729736328, 276.10809326171875]], \"label_ids\": [0, 0, 1, 2, 3, 3, 3, 3, 3, 5, 5, 5, 6, 6, 6, 7, 7, 7], \"scores\": [0.6386231184005737, 0.6369226574897766, 0.904525876045227, 0.9184497594833374, 0.7360845804214478, 0.7242023944854736, 0.709646999835968, 0.6357367038726807, 0.5030519366264343, 0.9688778519630432, 0.9632471203804016, 0.961919367313385, 0.9451444149017334, 0.8799272775650024, 0.7229852080345154, 0.9455613493919373, 0.9301577806472778, 0.8944724798202515]}\n";
        HeroKillOrAssistDetail detail = JSON.parseObject(s, HeroKillOrAssistDetail.class);
        LoLPicData loLPicData = new LoLPicData(0, 0, 0);
        loLPicData.setHeroKADetail(detail);

        List<List<Integer>> res = loLPicData.merge2PositionEnum();
        System.out.println(res);
    }


}
